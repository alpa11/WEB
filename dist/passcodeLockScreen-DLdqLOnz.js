import{R as F,o as L,T as K,U as Q,V as ee,q as le,W as G,X as fe,Y as W,Z as A,$ as T,a0 as x,a1 as h,a2 as S,a3 as he,a4 as I,a5 as M,a6 as we,a7 as X,a8 as de,a9 as te,i as U,v as D,aa as Pe,u as ne,ab as ue,ac as ke,m as ae,ad as se,ae as ge,af as _e,ag as pe,ah as Ce,ai as be,aj as Se,ak as Me,al as Le,am as N,an as Ee,ao as Ae,ap as Te,aq as $e}from"./index-CTd46-d9.js";import{T as Be,C as oe,a as Ue,b as Ie,S as z,f as Re}from"./focusInput-nNXvlz5d.js";const re=12,ie=16;function De(a,e){return a.length===e.length&&a.every((o,i)=>o===e[i])}const ye=1e5;async function me(a,e){const i=new TextEncoder().encode(a);a="";const r=await crypto.subtle.importKey("raw",i,{name:"PBKDF2"},!1,["deriveBits"]),_=await crypto.subtle.deriveBits({name:"PBKDF2",salt:e,iterations:ye,hash:"SHA-256"},r,256);return new Uint8Array(_)}async function ve(a,e){const i=new TextEncoder().encode(a);a="";const r=await crypto.subtle.importKey("raw",i,{name:"PBKDF2"},!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:ye,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function ce(a){const e=crypto.getRandomValues(new Uint8Array(ie)),o=crypto.getRandomValues(new Uint8Array(ie)),i=await ve(a,e),r=await me(a,o);return a="",{verificationHash:r,verificationSalt:o,encryptionSalt:e,encryptionKey:i}}function xe(){const{rootScope:a,apiManagerProxy:e}=F();async function o(){G.temporarilyToggle(!1),await e.invoke("toggleCacheStorage",!1),await e.serviceMessagePort.invoke("toggleCacheStorage",!1)}async function i(){G.temporarilyToggle(!0),await e.invoke("toggleCacheStorage",!0),await e.serviceMessagePort.invoke("toggleCacheStorage",!0)}async function r(){await G.clearEncryptableStorages()}async function _(t){const{verificationHash:P,verificationSalt:n,encryptionSalt:g,encryptionKey:u}=await ce(t);t="",await L.set({passcode:{verificationHash:P,verificationSalt:n,encryptionSalt:g}}),await a.managers.appStateManager.setByKey(Q("settings","passcode","enabled"),!0),await o(),await r();const l={isUsingPasscode:!0,encryptionKey:u};await e.invoke("toggleUsingPasscode",l),await e.serviceMessagePort.invoke("toggleUsingPasscode",l),a.dispatchEvent("toggle_using_passcode",!0),ee.resolveDeferred(!0),K.save(u),await i(),await le.updateStorageForLegacy(null)}async function b(t){const P=await L.get("passcode",!1);if(!P?.verificationHash||!P?.verificationSalt)return!1;const n=await me(t,P.verificationSalt);return t="",De(n,P.verificationHash)}async function c(){a.managers.appStateManager.setByKey(Q("settings","passcode","enabled"),!1),a.dispatchEvent("toggle_using_passcode",!1),await o(),await r(),await e.invoke("toggleUsingPasscode",{isUsingPasscode:!1}),await e.serviceMessagePort.invoke("toggleUsingPasscode",{isUsingPasscode:!1}),K.save(null),ee.resolveDeferred(!1),await i(),L.delete("passcode")}async function C(t){const{verificationHash:P,verificationSalt:n,encryptionSalt:g,encryptionKey:u}=await ce(t);t="";const l={verificationHash:P,verificationSalt:n,encryptionSalt:g};await o(),await r(),await e.invoke("changePasscode",{toStore:l,encryptionKey:u}),await e.serviceMessagePort.invoke("saveEncryptionKey",u),K.save(u),await i(),await L.set({passcode:l},!0)}async function f(t){const P=await L.get("passcode",!1);if(!P?.encryptionSalt)throw new Error("No encryption salt found in storage");const n=await ve(t,P.encryptionSalt);t="",K.save(n),await e.invoke("saveEncryptionKey",n),await e.serviceMessagePort.invoke("toggleUsingPasscode",{isUsingPasscode:!0,encryptionKey:n}),e.invokeVoid("toggleLockOthers",!1),a.dispatchEvent("toggle_locked",!1)}return{enablePasscode:_,isMyPasscode:b,disablePasscode:c,changePasscode:C,unlockWithPasscode:f}}const Ke="_PasswordMonkey_1h0e6_1",Fe="_hidden_1h0e6_8",Oe="_MonkeyImage_1h0e6_13",V={PasswordMonkey:Ke,hidden:Fe,MonkeyImage:Oe};var He=T("<img src=assets/img/password-monkey-closed.png>"),Ge=T("<div>");const Ne=a=>{const e=fe({size:100},a),{PasswordMonkey:o}=F(),[i,r]=W(),[_,b]=W(!1);return A(()=>{const c=new o(e.passwordInputField,e.size);c.load().then(()=>b(!0)),r(c),I(()=>{c.remove()})}),(()=>{var c=Ge(),C=e.ref;return typeof C=="function"?x(C,c):e.ref=c,h(c,()=>i().container,null),h(c,S(he,{get when(){return!_()},get children(){var f=He();return A(()=>M(f,V.MonkeyImage)),f}}),null),A(f=>{var t=V.PasswordMonkey,P={[V.hidden]:e.hidden},n=e.size+"px";return t!==f.e&&M(c,f.e=t),f.t=we(c,P,f.t),n!==f.a&&((f.a=n)!=null?c.style.setProperty("--size",n):c.style.removeProperty("--size")),f},{e:void 0,t:void 0,a:void 0}),c})()},ze="_Popup_1o70z_1",Ve={Popup:ze};var We=T('<div><div class=popup-container><div class=popup-header><div class=popup-title></div></div><div class=popup-description></div><div class=popup-buttons><button class="popup-button btn danger"></button><button class="popup-button btn primary"autofocus>');const Xe=a=>(X(()=>{const e=o=>{o.key==="Escape"&&a.onClose?.()};document.addEventListener("keydown",e),I(()=>{document.removeEventListener("keydown",e)})}),S(Pe,{get children(){return S(Be,{onEnter:async(e,o)=>{await D(0),e.classList.add("active"),await D(0),o()},onExit:async(e,o)=>{e.classList.remove("active"),await D(200),o()},get children(){return de(()=>!!a.visible)()&&(()=>{var e=We(),o=e.firstChild,i=o.firstChild,r=i.firstChild,_=i.nextSibling,b=_.nextSibling,c=b.firstChild,C=c.nextSibling;return e.$$click=f=>{f.target===f.currentTarget&&a.onClose?.()},h(r,()=>a.title),h(_,()=>a.description),te(c,"click",a.onConfirm,!0),x(ne,c,()=>!0),h(c,()=>a.confirmButtonContent),te(C,"click",a.onClose,!0),x(ne,C,()=>!0),h(C,()=>U("Cancel")),A(()=>M(e,"popup popup-peer popup-confirmation "+Ve.Popup)),e})()}})}}));ue(["click"]);const je="_Container_nve2r_1",qe="_CanvasCommon_nve2r_11",Ye="_blend_nve2r_22",$={Container:je,CanvasCommon:qe,blend:Ye};var Ze=T("<div>"),Je=T("<img>");const Qe=a=>{const{themeController:e}=F();let o;const i=new _e,[r,_]=ke({isMobile:ae.activeScreen===se.mobile}),[b,c]=W();async function C(n){return n===N?"assets/img/pattern.svg":Ie.getWallPaperStorageUrl(n)}async function f(n){try{return await C(n)}catch{return C(N)}}async function t(){try{const n=e.getTheme(),g=n.settings?.wallpaper?.slug,u=g?await C(g):void 0,{wallpaper:l}=e.getThemeSettings(n),k=!!l?.pFlags?.pattern,p=l.settings?.intensity&&l.settings.intensity/100,w=!!p&&p<0;return{backgroundUrl:u,isPattern:k,isDarkPattern:w,intensity:p,wallPaper:l}}catch{const n=e.getTheme(),g=Le.themes.find(s=>s.name===n.name),u=g.settings?.wallpaper?.slug||N,l=await f(u),{wallpaper:k}=e.getThemeSettings(g),p=!!k?.pFlags?.pattern,w=k.settings?.intensity&&k.settings.intensity/100,E=!!w&&w<0;return{backgroundUrl:l,isPattern:p,isDarkPattern:E,intensity:w,wallPaper:k}}}async function P(){const{backgroundUrl:n,isPattern:g,isDarkPattern:u,intensity:l,wallPaper:k}=await t();c(n);let p,w,E,s;if(n)if(g){const m=o.getBoundingClientRect(),d=oe.getInstance({element:o,url:n,width:m.width,height:m.height,mask:u});w=d.createCanvas(),w.classList.add($.CanvasCommon),u||w.classList.add($.blend),d.renderToCanvas(w)}else p=document.createElement("img"),p.classList.add($.CanvasCommon),Se(p,n);const y=Me(k);if(y){const{canvas:m,gradientRenderer:d}=Ue.create(y);E=m,a.gradientRendererRef(d),E.classList.add($.CanvasCommon)}if(l){let m;p?m=p:m=u?E:w;let d=Math.abs(l)*(u?.5:1);p?d=Math.max(.3,1-l):u&&(d=Math.max(.3,d)),m?.style.setProperty("--opacity-max",""+d)}return _({gradientCanvas:E,patternCanvas:w,image:p}),{patternRenderer:s}}return X(()=>{i.add(window)("resize",()=>{oe.resizeInstancesOf(o)}),i.add(ae)("changeScreen",(n,g)=>{_({isMobile:g===se.mobile})})}),ge(pe(()=>r.isMobile,()=>{if(r.isMobile)return;const n=P();I(()=>{const g=r.patternCanvas;n.then(({patternRenderer:u})=>{u?.cleanup(g)}),a.gradientRendererRef(void 0),_(Ce({isMobile:r.isMobile}))})})),I(()=>{i.removeAll()}),(()=>{var n=Ze(),g=o;return typeof g=="function"?x(g,n):o=n,h(n,()=>r.gradientCanvas,null),h(n,()=>r.patternCanvas,null),h(n,()=>r.image,null),h(n,(()=>{var u=de(()=>!!b());return()=>u()&&(()=>{var l=Je();return l.style.setProperty("visibility","hidden"),A(k=>{var p=$.CanvasCommon,w=b();return p!==k.e&&M(l,k.e=p),w!==k.t&&be(l,"src",k.t=w),k},{e:void 0,t:void 0}),l})()})(),null),A(()=>M(n,$.Container)),n})()},et="_Container_likt7_36",tt="_Card_likt7_46",nt="_Description_likt7_60",at="_Input_likt7_67",st="_SubmitButton_likt7_71",ot="_LogoutButton_likt7_75",B={Container:et,Card:tt,Description:nt,Input:at,SubmitButton:st,LogoutButton:ot};var rt=T("<div><div><form action><button type=button></button><button hidden type=submit></button></form><div>"),it=T("<button>");const ct=5,lt=60,gt=a=>{let e,o,i,r=0;const{isMyPasscode:_,unlockWithPasscode:b}=xe(),{InputFieldTsx:c,PasswordInputField:C,apiManagerProxy:f}=F(),t=Ee({isMonkeyHidden:!!a.fromLockIcon,isError:!1,tooManyAttempts:!1,passcode:"",isLogoutPopupOpen:!1}),[P]=Ae(()=>le.getUnencryptedTotalAccounts());X(()=>{r=0;const s=a.fromLockIcon;s&&(async()=>{const m=s.getBoundingClientRect(),d=i.getBoundingClientRect();s.style.setProperty("--x",d.left+d.width/2+"px"),s.style.setProperty("--y",d.top+d.height/2+"px"),s.style.setProperty("--scale",d.width/m.width+""),s.classList.add("passcode-lock-screen__animated-lock-icon--shift-body"),await D(500),s.classList.add("passcode-lock-screen__animated-lock-icon--disappear"),t.isMonkeyHidden=!1,await D(400),s.remove(),a.onAnimationEnd?.()})();const y=m=>{document.activeElement&&document.activeElement.tagName==="INPUT"||Re(o.input,m)};document.addEventListener("keydown",y),I(()=>{document.removeEventListener("keydown",y)})});let n;function g(){if(n?.(),t.gradientRenderer){let s=0;n=$e(0,1,200,y=>s=y),t.gradientRenderer.toNextPosition(()=>s)}}const u=Te(g,100,!0);ge(pe(()=>t.passcode,()=>{u(),t.isError=!1,t.tooManyAttempts=!1})),I(()=>{t.passcode="",o.input.value=""});const l=()=>!!t.passcode&&t.passcode.length<=re,k=async()=>{const s=structuredClone(await L.get("settings",!1)),y=s?.passcode?.canAttemptAgainOn;return y?y>Date.now()?!1:(t.tooManyAttempts=!1,r=0,s.passcode.canAttemptAgainOn=null,L.set({settings:s}),!0):!0};let p=!1;const w=async s=>{if(s?.preventDefault(),!p){p=!0;try{if(!await k())t.tooManyAttempts=!0;else if(l()&&await _(t.passcode))await b(t.passcode),a.onUnlock();else if(r++,t.isError=!0,r>ct){t.tooManyAttempts=!0;const y=structuredClone(await L.get("settings",!1));y.passcode.canAttemptAgainOn=Date.now()+lt*1e3,await L.set({settings:y})}}catch{t.isError=!0}finally{p=!1}}},E=S(c,{InputFieldClass:C,instanceRef:s=>void(o=s),get class(){return B.Input},get value(){return t.passcode},onRawInput:s=>void(t.passcode=s),label:"PasscodeLock.EnterYourPasscode",get errorLabel(){return t.tooManyAttempts?"PasscodeLock.TooManyAttempts":t.isError?"PasscodeLock.WrongPasscode":void 0},maxLength:re});return(()=>{var s=rt(),y=s.firstChild,m=y.firstChild,d=m.firstChild,O=d.nextSibling,H=m.nextSibling,j=e;return typeof j=="function"?x(j,s):e=s,h(s,S(Qe,{gradientRendererRef:v=>void(t.gradientRenderer=v)}),y),h(y,S(Ne,{get hidden(){return t.isMonkeyHidden},ref(v){var R=i;typeof R=="function"?R(v):i=v},passwordInputField:o}),m),h(y,S(z,{amount:"1.125rem"}),m),m.addEventListener("submit",w),h(m,E,d),h(m,S(z,{amount:"1rem"}),d),d.$$mousedown=()=>{w()},h(d,()=>U("PasscodeLock.Proceed")),O.style.setProperty("visibility","hidden"),O.style.setProperty("height","0"),O.style.setProperty("width","0"),h(y,S(z,{amount:"1.625rem"}),H),h(H,()=>U(P()>1?"PasscodeLock.ForgotPasscode.MultipleAccounts":"PasscodeLock.ForgotPasscode.OneAccount",[(()=>{var v=it();return v.$$click=()=>{t.isLogoutPopupOpen=!0},A(()=>M(v,B.LogoutButton)),v})()])),h(s,S(Xe,{get visible(){return t.isLogoutPopupOpen},get title(){return U("LogOut")},get description(){return U("PasscodeLock.LogoutPopup.Description")},get confirmButtonContent(){return U("LogOut")},onConfirm:()=>{f.invokeVoid("forceLogout",void 0)},onClose:()=>void(t.isLogoutPopupOpen=!1)}),null),A(v=>{var R=B.Container,q=B.Card,Y=`btn-primary btn-color-primary btn-large ${B.SubmitButton}`,Z=!t.passcode,J=B.Description;return R!==v.e&&M(s,v.e=R),q!==v.t&&M(y,v.t=q),Y!==v.a&&M(d,v.a=Y),Z!==v.o&&(d.disabled=v.o=Z),J!==v.i&&M(H,v.i=J),v},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),s})()};ue(["mousedown","click"]);export{gt as default};
//# sourceMappingURL=passcodeLockScreen-DLdqLOnz.js.map
